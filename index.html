<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>2026 九州之旅</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* 皇室藍配色 (還原目標網站風格) */
        :root { --color-blue: #2563EB; --color-dark: #1E3A8A; }
        .text-royal-blue { color: var(--color-blue); }
        .bg-royal-blue { background-color: var(--color-blue); }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F3F4F6; /* Gray-100 */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 動畫 */
        .scale-in-center { animation: scale-in-center 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes scale-in-center { 0% { transform: scale(0.98); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .sidebar-enter-active, .sidebar-leave-active { transition: transform 0.3s ease; }
        .sidebar-enter-from, .sidebar-leave-to { transform: translateX(-100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* 鋸齒狀邊緣 (票券用) */
        .ticket-jagged { position: relative; background: white; }
        .ticket-jagged::after {
            content: ""; position: absolute; bottom: -6px; left: 0; width: 100%; height: 12px;
            background: radial-gradient(circle, transparent 6px, white 6px);
            background-size: 18px 18px; background-position: -9px 0;
        }
    </style>
</head>
<body class="text-gray-900 selection:bg-blue-100">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-safe">

    <header class="sticky top-0 z-30 bg-white/95 backdrop-blur-md border-b border-gray-100 p-4 pt-safe">
        <div class="flex justify-between items-center mb-2">
            <button @click="isMenuOpen = true" class="text-gray-600 text-xl p-2 hover:bg-gray-100 rounded-full transition-colors">
                <i class="fas fa-bars"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-black text-gray-800 tracking-tight">{{ activeMenuName }}</h1>
                <div class="flex items-center justify-center space-x-1 mt-0.5">
                    <div :class="dbConnected ? 'bg-green-500' : 'bg-red-400'" class="w-1.5 h-1.5 rounded-full animate-pulse"></div>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">{{ dbConnected ? 'SYNCED' : 'CONNECTING' }}</span>
                </div>
            </div>
            <button @click="isEditMode = !isEditMode" 
                    :class="isEditMode ? 'bg-blue-600 text-white shadow-blue-200' : 'bg-gray-100 text-gray-600'"
                    class="text-xs px-4 py-2 rounded-full font-bold transition-all shadow-md active:scale-95">
                {{ isEditMode ? '完成' : '編輯' }}
            </button>
        </div>

        <nav v-if="activeTab === 'itinerary'" class="mt-2 scale-in-center">
            <div class="flex items-center space-x-2 overflow-x-auto no-scrollbar w-full pb-1">
                <button v-for="(date, index) in tripDates" :key="date.id"
                        @click="activeDateId = date.id"
                        :class="activeDateId === date.id ? 'bg-blue-600 text-white shadow-md shadow-blue-200' : 'bg-gray-50 text-gray-400 border border-gray-100'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all min-w-[75px] text-center">
                    <div class="text-[9px] uppercase opacity-70 mb-0.5">Day {{ index + 1 }}</div>
                    <div class="tracking-tighter">{{ formatDate(date.fullDate) }}</div>
                </button>
                <button v-if="isEditMode" @click="addDay" class="flex-shrink-0 w-10 h-10 border-2 border-dashed border-gray-200 rounded-xl text-gray-400">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </nav>
    </header>

    <transition name="fade"><div v-if="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm"></div></transition>
    <transition name="sidebar">
        <aside v-if="isMenuOpen" class="fixed top-0 left-0 h-full w-64 bg-white z-50 shadow-2xl p-6 flex flex-col justify-between pt-safe">
            <div>
                <h2 class="text-2xl font-black text-gray-800 mb-8 px-2 border-l-4 border-blue-600 pl-4">2026 Kyushu</h2>
                <ul class="space-y-2">
                    <li v-for="menu in menus" :key="menu.id" 
                        @click="switchTab(menu.id)"
                        :class="activeTab === menu.id ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex items-center space-x-4 p-4 rounded-2xl cursor-pointer transition-all font-bold">
                        <div class="w-8 text-center"><i :class="menu.icon" class="text-lg"></i></div>
                        <span>{{ menu.name }}</span>
                    </li>
                </ul>
            </div>
            <div class="text-xs text-gray-300 text-center font-bold pb-8">v2026.Kyushu.Final</div>
        </aside>
    </transition>

    <main class="p-4 pb-24">
        
        <section v-if="activeTab === 'info'" class="scale-in-center space-y-6">
            
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-bold opacity-80 uppercase tracking-widest mb-1">Fukuoka / Nagasaki</p>
                        <h3 class="text-4xl font-black tracking-tighter">{{ weather.temp }}°C</h3>
                        <p class="text-sm font-medium opacity-90">{{ weather.desc }}</p>
                    </div>
                    <div class="text-right">
                        <i :class="weather.icon" class="text-5xl mb-2 block filter drop-shadow-md"></i>
                        <span class="text-[10px] bg-white/20 px-2 py-1 rounded-full">濕度: --%</span>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[1.5rem] p-4 shadow-sm flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-exchange-alt"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">即時匯率</p>
                        <p class="font-black text-gray-800 text-lg">1 JPY ≈ {{ exchangeRate }} TWD</p>
                    </div>
                </div>
                <button @click="fetchRate" class="text-gray-400 p-2 active:text-blue-500 transition-all"><i class="fas fa-sync-alt" :class="loadingRate ? 'animate-spin' : ''"></i></button>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-2">
                    <h4 class="font-black text-gray-800 flex items-center"><i class="fas fa-sticky-note mr-2 text-blue-600"></i>旅行筆記</h4>
                    <button v-if="isEditMode" @click="addNote" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold shadow-md">+ 新增</button>
                </div>
                <div v-if="notes.length > 0" class="grid grid-cols-1 gap-3">
                    <div v-for="note in notes" :key="note.id" class="bg-white border border-gray-100 rounded-[1.5rem] p-5 shadow-sm relative">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-black text-gray-800 text-sm uppercase tracking-wider">{{ note.title }}</h5>
                            <button v-if="isEditMode" @click="deleteNote(note.id)" class="text-red-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">{{ note.content }}</p>
                    </div>
                </div>
                <div v-else class="text-center py-6 bg-gray-50 rounded-[1.5rem] text-gray-300 text-xs font-bold border-2 border-dashed border-gray-100">暫無筆記 (點擊編輯新增)</div>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h4 class="font-black text-gray-800 flex items-center"><i class="fas fa-plane-departure mr-2 text-blue-600"></i>航班與住宿</h4>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-800 p-3 flex justify-between items-center text-white">
                        <div class="text-xs font-bold uppercase tracking-widest"><i class="fas fa-ticket-alt mr-2"></i>E-Ticket</div>
                        <div class="text-[10px] font-mono bg-white/20 px-2 py-0.5 rounded">KYUSHU 2026</div>
                    </div>
                    <div class="p-5 relative ticket-jagged">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-dashed border-gray-200">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-[10px] text-gray-400 font-bold">04/09 07:10</div>
                            </div>
                            <div class="flex-1 px-2 text-center">
                                <i class="fas fa-plane text-blue-500 text-sm"></i>
                                <div class="text-[9px] text-gray-400 font-bold mt-1">IT 246</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">HSG</div>
                                <div class="text-[10px] text-gray-400 font-bold">10:35</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">FUK</div>
                                <div class="text-[10px] text-gray-400 font-bold">04/15 11:00</div>
                            </div>
                            <div class="flex-1 px-2 text-center">
                                <i class="fas fa-plane text-pink-500 text-sm transform rotate-180"></i>
                                <div class="text-[9px] text-gray-400 font-bold mt-1">CI 0111</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-[10px] text-gray-400 font-bold">12:30</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="hotels.length > 0" class="space-y-2">
                    <div v-for="h in hotels" :key="h.id" class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm flex justify-between items-center">
                        <div class="flex-1 mr-2">
                            <span class="bg-indigo-50 text-indigo-600 text-[10px] font-black px-2 py-0.5 rounded mr-2">HOTEL</span>
                            <span class="text-xs font-bold text-gray-700">{{ h.name }}</span>
                            <p class="text-[10px] text-gray-400 mt-1 ml-1">{{ h.checkIn }} - {{ h.checkOut }}</p>
                        </div>
                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + h.name" target="_blank" class="w-8 h-8 flex items-center justify-center bg-gray-50 text-gray-400 rounded-full">
                            <i class="fas fa-map-marked-alt text-xs"></i>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="activeTab === 'itinerary'" class="scale-in-center">
            <div v-if="tripDates.length > 0">
                <div v-if="isEditMode" class="mb-4">
                    <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-[2rem] text-gray-400 text-sm font-bold hover:bg-gray-50 transition-all">
                        <i class="fas fa-plus-circle mr-2 text-blue-600"></i>新增行程到 Day {{ activeDateId.replace('day','') }}
                    </button>
                </div>
                <div v-if="currentItinerary.length > 0" class="space-y-3">
                    <article v-for="item in currentItinerary" :key="item.id" 
                             :class="[getStyles(item.category).border, getStyles(item.category).shadow]"
                             class="p-5 bg-white border border-gray-100 rounded-[1.8rem] border-l-[6px] flex justify-between items-center shadow-sm card-transition">
                        <div class="flex-1 pr-3">
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="text-sm font-black text-gray-800"><i class="far fa-clock mr-1 text-blue-600"></i>{{ item.time }}</span>
                                <span :class="getStyles(item.category).bg" class="text-[9px] px-2 py-0.5 rounded text-white font-bold tracking-wide">{{ item.category }}</span>
                            </div>
                            <h3 class="font-bold text-gray-900 text-lg leading-snug">{{ item.name }}</h3>
                            <p v-if="item.notes" class="text-xs text-gray-500 mt-1">{{ item.notes }}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <a :href="'https://www.google.com/maps/search/?api=1&query=' + item.name + ' ' + (item.region || '')" target="_blank" 
                               class="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-400 rounded-full active:bg-gray-200">
                                <i class="fas fa-location-arrow"></i>
                            </a>
                            <button v-if="isEditMode" @click="deleteItem(item.id)" class="text-red-300 px-2"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </article>
                </div>
                <div v-else class="text-center py-20 bg-gray-50 rounded-[3rem] border-2 border-dashed border-gray-100"><p class="text-gray-400 font-bold text-sm">今日尚無規劃</p></div>
            </div>
        </section>

        <section v-if="activeTab === 'shopping'" class="scale-in-center space-y-4">
            <div v-if="isEditMode" class="mb-4">
                <button @click="addShoppingItem" class="w-full py-4 border-2 border-dashed border-pink-200 rounded-3xl text-pink-500 text-sm font-bold bg-pink-50/30">
                    <i class="fas fa-cart-plus mr-2"></i>新增項目
                </button>
            </div>
            <div v-for="item in shoppingList" :key="item.id" 
                 @click="toggleCheck(item)"
                 class="p-5 bg-white border border-gray-100 rounded-[1.8rem] flex justify-between items-center shadow-sm"
                 :class="item.checked ? 'opacity-50 grayscale' : ''">
                <div class="flex-1">
                    <h3 class="font-bold text-gray-800 text-lg" :class="item.checked ? 'line-through' : ''">{{ item.name }}</h3>
                    <div class="flex items-center mt-1 space-x-2">
                        <span class="bg-gray-100 text-gray-500 text-[9px] px-2 py-0.5 rounded-md font-bold uppercase">{{ item.region }}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <i :class="item.checked ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-300'" class="text-2xl"></i>
                    <button v-if="isEditMode" @click.stop="deleteShoppingItem(item.id)" class="text-red-300 p-2"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </section>

        <section v-if="activeTab === 'food'" class="scale-in-center space-y-4">
            <div v-if="isEditMode" class="mb-4">
                <button @click="addFoodItem" class="w-full py-4 border-2 border-dashed border-orange-200 rounded-3xl text-orange-500 text-sm font-bold bg-orange-50/30">
                    <i class="fas fa-utensils mr-2"></i>新增餐廳
                </button>
            </div>
            <div v-for="item in foodList" :key="item.id" 
                 class="p-5 bg-white border border-gray-100 rounded-[1.8rem] flex justify-between items-center shadow-sm border-l-[6px] border-orange-400">
                <div class="flex-1">
                    <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                    <div class="flex items-center mt-1 space-x-2">
                        <span class="bg-orange-50 text-orange-600 text-[9px] px-2 py-0.5 rounded-md font-black uppercase">{{ item.region }}</span>
                        <p class="text-xs text-gray-400">{{ item.note }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + item.name + ' ' + item.region" target="_blank" class="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-400 rounded-full">
                        <i class="fas fa-location-arrow"></i>
                    </a>
                    <button v-if="isEditMode" @click="deleteFoodItem(item.id)" class="text-red-300 p-2"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </section>

        <section v-if="activeTab === 'expense'" class="scale-in-center space-y-6">
            <div class="bg-gray-900 rounded-[2rem] p-6 text-white shadow-xl">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Expense</p>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-3xl font-black">¥ {{ totalExpenseJPY.toLocaleString() }}</p>
                        <p class="text-sm text-gray-400 mt-1">≈ TWD {{ (totalExpenseJPY * exchangeRate).toFixed(0) }}</p>
                    </div>
                </div>
            </div>
            <div v-if="isEditMode">
                <button @click="addExpense" class="w-full py-4 border-2 border-dashed border-emerald-200 rounded-3xl text-emerald-600 text-sm font-bold bg-emerald-50/30">
                    <i class="fas fa-plus mr-2"></i>記一筆
                </button>
            </div>
            <div v-if="expenses.length > 0" class="space-y-3">
                <div v-for="exp in expenses" :key="exp.id" class="bg-white border border-gray-100 rounded-[1.5rem] p-4 flex justify-between items-center shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs text-white bg-blue-500">
                            ¥
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">{{ exp.item }}</h4>
                            <p class="text-[10px] text-gray-400">{{ exp.date }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-lg text-gray-800">¥{{ exp.amount }}</p>
                        <button v-if="isEditMode" @click="deleteExpense(exp.id)" class="text-red-300 text-[10px] mt-1">刪除</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div v-if="showAddModal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div @click="showAddModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[3rem] sm:rounded-[3rem] p-8 scale-in-center shadow-2xl">
            <h2 class="text-2xl font-black mb-8">新增行程</h2>
            <div class="space-y-6">
                <input v-model="newItem.name" placeholder="名稱..." class="w-full border-b-2 border-gray-100 p-2.5 text-lg font-bold outline-none focus:border-blue-600">
                <div class="grid grid-cols-2 gap-6">
                    <input v-model="newItem.time" type="time" class="w-full border-b-2 border-gray-100 p-2.5 outline-none font-bold">
                    <select v-model="newItem.category" class="w-full border-b-2 border-gray-100 p-2.5 outline-none font-bold bg-white">
                        <option>景點</option><option>美食</option><option>交通</option><option>購物</option>
                    </select>
                </div>
            </div>
            <button @click="saveNewItem" class="w-full mt-10 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">儲存</button>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // 1. Firebase Configuration (已填入)
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyCGprnuwAqCKwt1GoCrbAevGdg_hZlZFdg",
        authDomain: "kyushu-7ee56.firebaseapp.com",
        databaseURL: "https://kyushu-7ee56-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kyushu-7ee56",
        storageBucket: "kyushu-7ee56.firebasestorage.app",
        messagingSenderId: "440536663087",
        appId: "1:440536663087:web:7dcd2d3263346ca61a72da",
        measurementId: "G-0FZ0X5H2FT"
    };
    
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // UI State
            const isMenuOpen = ref(false);
            const activeTab = ref('itinerary'); // Default to itinerary
            const isEditMode = ref(false);
            const activeDateId = ref('day1');
            const showAddModal = ref(false);
            const dbConnected = ref(false);
            const loadingRate = ref(false);

            // API Data
            const weather = ref({ temp: '--', desc: '載入中', icon: 'fas fa-cloud' });
            const exchangeRate = ref(0.22);

            // App Data
            const notes = ref([]);
            const itineraryData = ref([]);
            const shoppingList = ref([]);
            const foodList = ref([]);
            const expenses = ref([]);

            const menus = [
                { id: 'info', name: '資訊', icon: 'fas fa-info-circle' },
                { id: 'itinerary', name: '行程', icon: 'fas fa-map-marked-alt' },
                { id: 'shopping', name: '購物', icon: 'fas fa-shopping-bag' },
                { id: 'food', name: '美食', icon: 'fas fa-utensils' },
                { id: 'expense', name: '花費', icon: 'fas fa-wallet' }
            ];

            const tripDates = [
                { id: 'day1', fullDate: '2026-04-09' }, { id: 'day2', fullDate: '2026-04-10' },
                { id: 'day3', fullDate: '2026-04-11' }, { id: 'day4', fullDate: '2026-04-12' },
                { id: 'day5', fullDate: '2026-04-13' }, { id: 'day6', fullDate: '2026-04-14' },
                { id: 'day7', fullDate: '2026-04-15' }
            ];

            const hotels = ref([
                { id: 1, name: 'CANDEO HOTELS Nagasaki', checkIn: '04/09', checkOut: '04/11' },
                { id: 2, name: 'Nishitetsu Hotel Croom Hakata', checkIn: '04/11', checkOut: '04/15' }
            ]);

            // API Logic
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.40&current_weather=true&timezone=Asia%2FTokyo');
                    const data = await res.json();
                    if(data.current_weather) {
                        weather.value.temp = data.current_weather.temperature;
                        const code = data.current_weather.weathercode;
                        weather.value.desc = getWeatherDesc(code);
                        weather.value.icon = getWeatherIcon(code);
                    }
                } catch(e) { console.error(e); }
            };
            const getWeatherIcon = (c) => c===0?'fas fa-sun text-yellow-300':(c<3?'fas fa-cloud-sun':'fas fa-cloud');
            const getWeatherDesc = (c) => c===0?'晴朗':(c<3?'多雲':'陰雨');

            const fetchRate = async () => {
                loadingRate.value = true;
                try {
                    const res = await fetch('https://api.frankfurter.app/latest?from=JPY&to=TWD');
                    const data = await res.json();
                    if(data.rates.TWD) exchangeRate.value = data.rates.TWD.toFixed(3);
                } catch(e) {}
                loadingRate.value = false;
            };

            // Firebase Logic
            onMounted(() => {
                fetchWeather(); fetchRate();
                db.ref('trips/kyushu2026').on('value', (snap) => {
                    dbConnected.value = true;
                    const d = snap.val();
                    if(d) {
                        if(d.itinerary) itineraryData.value = d.itinerary;
                        if(d.shopping) shoppingList.value = d.shopping;
                        if(d.food) foodList.value = d.food;
                        if(d.expenses) expenses.value = d.expenses;
                        if(d.notes) notes.value = d.notes;
                    } else {
                        // 初始化資料
                        const initData = {
                            itinerary: [
                                { id: 100, dateId: 'day1', time: '07:10', name: 'IT246 起飛', category: '交通', notes: 'TPE 往 佐賀' },
                                { id: 101, dateId: 'day1', time: '11:44', name: '佐賀機場巴士', category: '交通', notes: '往佐賀站' },
                                { id: 107, dateId: 'day1', time: '19:30', name: '稻佐山夜景', category: '景點', notes: '纜車' },
                                { id: 201, dateId: 'day2', time: '09:00', name: '軍艦島', category: '景點', notes: '需預約' },
                                { id: 702, dateId: 'day7', time: '11:00', name: 'CI 0111 起飛', category: '交通', notes: 'FUK T1 -> TPE' }
                            ],
                            shopping: [{ id: 1, name: '長崎蛋糕', region: '長崎', checked: false }],
                            food: [{ id: 1, name: '拉麵柊', region: '長崎', note: '茄子拉麵' }],
                            notes: [{ id: 1, title: '重要', content: '護照、VJW截圖要帶' }]
                        };
                        db.ref('trips/kyushu2026').set(initData);
                    }
                });
            });

            const updateRemote = (key, data) => db.ref(`trips/kyushu2026/${key}`).set(JSON.parse(JSON.stringify(data)));

            // Actions
            const newItem = ref({ time: '12:00', name: '', category: '景點' });
            const openAddModal = () => showAddModal.value = true;
            const saveNewItem = () => {
                if(!newItem.value.name) return;
                const list = [...itineraryData.value, { ...newItem.value, id: Date.now(), dateId: activeDateId.value, notes: '' }];
                itineraryData.value = list; updateRemote('itinerary', list); showAddModal.value = false; newItem.value.name = '';
            };
            const deleteItem = (id) => { if(confirm('刪除?')) { const list = itineraryData.value.filter(i=>i.id!==id); itineraryData.value=list; updateRemote('itinerary', list); }};
            const toggleCheck = (item) => { item.checked = !item.checked; updateRemote('shopping', shoppingList.value); };
            const addShoppingItem = () => { const n = prompt('名稱'); if(n) { shoppingList.value.push({id:Date.now(), name:n, region:'-', checked:false}); updateRemote('shopping', shoppingList.value); }};
            const deleteShoppingItem = (id) => { shoppingList.value = shoppingList.value.filter(i=>i.id!==id); updateRemote('shopping', shoppingList.value); };
            const addFoodItem = () => { const n = prompt('餐廳'); if(n) { foodList.value.push({id:Date.now(), name:n, region:'-', note:''}); updateRemote('food', foodList.value); }};
            const deleteFoodItem = (id) => { foodList.value = foodList.value.filter(i=>i.id!==id); updateRemote('food', foodList.value); };
            const addExpense = () => { const i=prompt('項目'), a=prompt('金額'); if(i&&a) { expenses.value.push({id:Date.now(), item:i, amount:parseInt(a), date: 'Today'}); updateRemote('expenses', expenses.value); }};
            const deleteExpense = (id) => { expenses.value = expenses.value.filter(i=>i.id!==id); updateRemote('expenses', expenses.value); };
            
            // Note Actions
            const addNote = () => { const t=prompt('標題'), c=prompt('內容'); if(t&&c) { notes.value.push({id:Date.now(), title:t, content:c}); updateRemote('notes', notes.value); }};
            const deleteNote = (id) => { if(confirm('刪除筆記?')) { notes.value = notes.value.filter(i=>i.id!==id); updateRemote('notes', notes.value); }};

            // Helpers
            const switchTab = (id) => { activeTab.value = id; isMenuOpen.value = false; };
            const activeMenuName = computed(() => menus.find(m => m.id === activeTab.value)?.name);
            const currentItinerary = computed(() => itineraryData.value.filter(i => i.dateId === activeDateId.value).sort((a,b) => a.time.localeCompare(b.time)));
            const totalExpenseJPY = computed(() => expenses.value.reduce((s,i) => s + i.amount, 0));
            const formatDate = (s) => { const d = new Date(s); return `${d.getMonth()+1}/${d.getDate()} ${['日','一','二','三','四','五','六'][d.getDay()]}`; };
            
            const getStyles = (c) => {
                if(c==='美食') return {bg:'bg-orange-500', border:'border-orange-400', shadow:'shadow-orange-100'};
                if(c==='購物') return {bg:'bg-pink-500', border:'border-pink-400', shadow:'shadow-pink-100'};
                if(c==='交通') return {bg:'bg-blue-500', border:'border-blue-400', shadow:'shadow-blue-100'};
                return {bg:'bg-teal-500', border:'border-teal-400', shadow:'shadow-teal-100'};
            };

            return {
                isMenuOpen, activeTab, isEditMode, activeDateId, dbConnected, showAddModal,
                weather, exchangeRate, loadingRate,
                menus, tripDates, hotels, currentItinerary, shoppingList, foodList, expenses, notes,
                totalExpenseJPY, activeMenuName, switchTab, formatDate, getStyles,
                newItem, openAddModal, saveNewItem, deleteItem,
                toggleCheck, addShoppingItem, deleteShoppingItem, addFoodItem, deleteFoodItem, addExpense, deleteExpense,
                addNote, deleteNote, fetchRate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
